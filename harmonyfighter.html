<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Symphony of Clashes: Rhythm Edition</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        wood: {
                            900: '#1a1510', // Deep background
                            800: '#2c241b', // Panel background
                            700: '#3e3226', // Lighter panel
                            600: '#5c4b37', // Borders
                            500: '#8b5a2b', // Wood accent
                        },
                        gold: {
                            100: '#f9f1d0',
                            300: '#f0e68c',
                            400: '#ffd700',
                            500: '#d4af37', // Antique Gold
                            600: '#b8860b',
                            700: '#aa7e08',
                        },
                        ivory: '#fffff0',
                        velvet: {
                            900: '#2a0a0a',
                            500: '#800000',
                        }
                    },
                    fontFamily: {
                        serif: ['"Noto Serif KR"', 'serif'],
                        sans: ['"Noto Sans KR"', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <!-- React 17 (Stable) -->
    <script crossorigin src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>

    <!-- Babel Standalone -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;700&family=Noto+Sans+KR:wght@400;700&display=swap');

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #1a1510;
            /* Wood 900 */
            color: #fffff0;
            /* Ivory */
            overflow: hidden;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1a1510;
        }

        ::-webkit-scrollbar-thumb {
            background: #5c4b37;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #d4af37;
        }

        /* Animations */
        @keyframes bounce {

            0%,
            100% {
                transform: translateY(-25%);
                animation-timing-function: cubic-bezier(0.8, 0, 1, 1);
            }

            50% {
                transform: none;
                animation-timing-function: cubic-bezier(0, 0, 0.2, 1);
            }
        }

        .animate-bounce {
            animation: bounce 1s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: .5;
            }
        }

        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        .wood-texture {
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100' height='100' filter='url(%23noise)' opacity='0.08'/%3E%3C/svg%3E");
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        // React Hooks
        const { useState, useEffect, useRef, useCallback } = React;

        // --- Constants & Game Data ---
        const RARITIES = {
            NORMAL: { name: 'Normal', color: 'text-gray-400', border: 'border-wood-600', bg: 'bg-wood-800', multiplier: 1.0, prob: 0.5 },
            RARE: { name: 'Rare', color: 'text-blue-300', border: 'border-blue-800', bg: 'bg-[#1a2a3a]', multiplier: 1.2, prob: 0.3 },
            SUPER_RARE: { name: 'Super Rare', color: 'text-purple-300', border: 'border-purple-900', bg: 'bg-[#2a1a3a]', multiplier: 1.5, prob: 0.15 },
            ULTRA_RARE: { name: 'Ultra Rare', color: 'text-gold-400', border: 'border-gold-600', bg: 'bg-[#3a2a1a]', multiplier: 2.0, prob: 0.04 },
            HYPER_RARE: { name: 'Hyper Rare', color: 'text-red-400', border: 'border-red-900', bg: 'bg-velvet-900', multiplier: 3.0, prob: 0.009 },
            SECRET: { name: 'Secret', color: 'text-rose-300', border: 'border-rose-500', bg: 'bg-black', multiplier: 5.0, prob: 0.001 },
        };

        const ELEMENTS = {
            BRASS: { name: 'Í∏àÍ¥Ä', icon: 'üé∫', color: 'text-gold-500', weakTo: 'PERCUSSION', strongAgainst: 'WOODWIND' },
            WOODWIND: { name: 'Î™©Í¥Ä', icon: 'üéã', color: 'text-green-600', weakTo: 'BRASS', strongAgainst: 'STRINGS' },
            STRINGS: { name: 'ÌòÑÏïÖ', icon: 'üéª', color: 'text-purple-400', weakTo: 'WOODWIND', strongAgainst: 'PERCUSSION' },
            PERCUSSION: { name: 'ÌÉÄÏïÖ', icon: 'ü•Å', color: 'text-orange-700', weakTo: 'STRINGS', strongAgainst: 'BRASS' },
            ELECTRONIC: { name: 'Ï†ÑÏûê', icon: 'üéπ', color: 'text-blue-400', weakTo: 'VOCAL', strongAgainst: 'VOCAL' },
            VOCAL: { name: 'ÏÑ±ÏïÖ', icon: 'üé§', color: 'text-pink-400', weakTo: 'ELECTRONIC', strongAgainst: 'ELECTRONIC' },
        };

        const INSTRUMENTS = {
            BRASS: ['Ìä∏ÎüºÌé´', 'Ìä∏Î°¨Î≥∏', 'ÌäúÎ∞î', 'Ìò∏Î•∏'],
            WOODWIND: ['ÌîåÎ£®Ìä∏', 'ÌÅ¥ÎùºÎ¶¨ÎÑ∑', 'Ïò§Î≥¥Ïóê', 'Î∞îÏàú'],
            STRINGS: ['Î∞îÏù¥Ïò¨Î¶∞', 'ÎπÑÏò¨Îùº', 'Ï≤ºÎ°ú', 'ÌïòÌîÑ'],
            PERCUSSION: ['ÌåÄÌååÎãà', 'Ïä§ÎÑ§Ïñ¥', 'Ïã¨Î≤åÏ¶à', 'ÎßàÎ¶ºÎ∞î'],
            ELECTRONIC: ['Ïã†ÎîîÏÇ¨Ïù¥Ï†Ä', 'ÏùºÎ†âÍ∏∞ÌÉÄ', 'Î≤†Ïù¥Ïä§', 'Îü∞ÏπòÌå®Îìú'],
            VOCAL: ['ÏÜåÌîÑÎùºÎÖ∏', 'ÌÖåÎÑà', 'Î∞îÎ¶¨ÌÜ§', 'ÏïåÌÜ†'],
        };

        // --- Icons ---
        const IconBase = ({ children, size = 24, className = "", color = "currentColor" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {children}
            </svg>
        );
        const Music = (props) => <IconBase {...props}><path d="M9 18V5l12-2v13" /><circle cx="6" cy="18" r="3" /><circle cx="18" cy="16" r="3" /></IconBase>;
        const Skull = (props) => <IconBase {...props}><path d="M14 16v2" /><path d="M10 16v2" /><circle cx="12" cy="10" r="9" /><circle cx="10" cy="10" r="1" /><circle cx="14" cy="10" r="1" /><path d="M12 21a6 6 0 0 0 6-6H6a6 6 0 0 0 6 6z" /></IconBase>;
        const Play = (props) => <IconBase {...props}><polygon points="5 3 19 12 5 21 5 3" /></IconBase>;
        const Users = (props) => <IconBase {...props}><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" /><circle cx="9" cy="7" r="4" /><path d="M23 21v-2a4 4 0 0 0-3-3.87" /><path d="M16 3.13a4 4 0 0 1 0 7.75" /></IconBase>;
        const Gift = (props) => <IconBase {...props}><polyline points="20 12 20 22 4 22 4 12" /><rect x="2" y="7" width="20" height="5" /><line x1="12" y1="22" x2="12" y2="7" /><path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z" /><path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z" /></IconBase>;
        const Keyboard = (props) => <IconBase {...props}><rect x="2" y="4" width="20" height="16" rx="2" ry="2" /><line x1="6" y1="8" x2="6" y2="8" /><line x1="10" y1="8" x2="10" y2="8" /><line x1="14" y1="8" x2="14" y2="8" /><line x1="18" y1="8" x2="18" y2="8" /><line x1="6" y1="12" x2="6" y2="12" /><line x1="10" y1="12" x2="10" y2="12" /><line x1="14" y1="12" x2="14" y2="12" /><line x1="18" y1="12" x2="18" y2="12" /><line x1="6" y1="16" x2="18" y2="16" /></IconBase>;


        // --- Helper Functions ---
        const generateCharacter = (fixedRarity = null) => {
            const rand = Math.random();
            let rarityKey = 'NORMAL';
            if (fixedRarity) {
                rarityKey = fixedRarity;
            } else {
                let cumulative = 0;
                for (const key in RARITIES) {
                    cumulative += RARITIES[key].prob;
                    if (rand <= cumulative) { rarityKey = key; break; }
                }
            }
            const elemKeys = Object.keys(ELEMENTS);
            const elementKey = elemKeys[Math.floor(Math.random() * elemKeys.length)];
            const instrumentList = INSTRUMENTS[elementKey];
            const name = instrumentList[Math.floor(Math.random() * instrumentList.length)];
            const rarity = RARITIES[rarityKey];
            const baseAtk = Math.floor((10 + Math.random() * 10) * rarity.multiplier);
            const baseHp = Math.floor((100 + Math.random() * 50) * rarity.multiplier);
            const interval = Math.floor(Math.random() * 3) + 2;
            return {
                id: Math.random().toString(36).substr(2, 9),
                name, element: elementKey, rarity: rarityKey,
                atk: baseAtk, maxHp: baseHp, hp: baseHp,
                interval: interval, skillCooldown: 0, maxCooldown: 8, isDead: false,
            };
        };

        const getElementEffectiveness = (atkElem, defElem) => {
            const attacker = ELEMENTS[atkElem];
            if (attacker.strongAgainst === defElem) return 1.5;
            if (attacker.weakTo === defElem) return 0.5;
            if ((atkElem === 'ELECTRONIC' && defElem === 'VOCAL') || (atkElem === 'VOCAL' && defElem === 'ELECTRONIC')) return 2.0;
            return 1.0;
        };

        const findTargetIndex = (myIndex, targetTeam) => {
            if (targetTeam[myIndex] && !targetTeam[myIndex].isDead) return myIndex;
            for (let offset = 1; offset < 5; offset++) {
                const right = myIndex + offset;
                const left = myIndex - offset;
                if (right < 5 && targetTeam[right] && !targetTeam[right].isDead) return right;
                if (left >= 0 && targetTeam[left] && !targetTeam[left].isDead) return left;
            }
            return null;
        };

        // --- Main Application Component ---
        function App() {
            const [view, setView] = useState('MENU');
            const [currency, setCurrency] = useState(2000);
            const [inventory, setInventory] = useState(() => Array(5).fill(null).map(() => generateCharacter('NORMAL')));
            const [formation, setFormation] = useState([0, 1, 2, 3, 4]);
            const [currentStage, setCurrentStage] = useState(1);
            const [gachaResult, setGachaResult] = useState(null);

            const [combatState, setCombatState] = useState(null);
            const [beat, setBeat] = useState(0);

            const combatRef = useRef(null);
            const timerRef = useRef(null);
            const lastBeatTimeRef = useRef(0);
            const BPM = 100;
            const BEAT_MS = (60 / BPM) * 1000;

            const [rhythmFeedback, setRhythmFeedback] = useState({ text: "READY", color: "text-ivory", scale: 1, combo: 0 });
            const [conductorBonus, setConductorBonus] = useState(1.0);

            useEffect(() => { combatRef.current = combatState; }, [combatState]);

            const startCombat = (stageNum) => {
                const playerTeam = formation.map(idx => {
                    if (idx === null || !inventory[idx]) return null;
                    const char = inventory[idx];
                    const safeMaxHp = typeof char.maxHp === 'number' ? char.maxHp : 100;
                    return { ...char, hp: safeMaxHp, skillCooldown: 0, isDead: false, maxHp: safeMaxHp };
                });

                const isBoss = stageNum % 10 === 0;
                const baseScale = 1 + (stageNum * 0.05);
                const decadeBonus = Math.floor((stageNum - 1) / 10) * 0.2;
                const finalScale = baseScale + decadeBonus;

                const enemyTeam = Array(5).fill(null).map((_, i) => {
                    const spawnProb = 0.6 + (stageNum * 0.003);
                    if (Math.random() > Math.min(0.9, spawnProb) && !isBoss) return null;
                    if (isBoss && i !== 2) return Math.random() > 0.5 ? generateCharacter('NORMAL') : null;
                    const rarity = isBoss && i === 2 ? 'ULTRA_RARE' : 'NORMAL';
                    const enemy = generateCharacter(rarity);
                    const eMaxHp = Math.floor(enemy.maxHp * finalScale * (isBoss ? 3 : 1));
                    enemy.maxHp = eMaxHp;
                    enemy.hp = eMaxHp;
                    enemy.atk = Math.floor(enemy.atk * finalScale);
                    enemy.name = isBoss ? `MAESTRO ${enemy.name}` : enemy.name;
                    return enemy;
                });
                if (enemyTeam.every(e => e === null)) enemyTeam[2] = generateCharacter('NORMAL');

                setCombatState({ playerTeam, enemyTeam, stage: stageNum, logs: [], measure: 1, isPlaying: true, result: null });
                setBeat(0);
                setConductorBonus(1.0);
                setRhythmFeedback({ text: "READY", color: "text-ivory", scale: 1, combo: 0 });
                lastBeatTimeRef.current = Date.now();
                setView('COMBAT');
            };

            useEffect(() => {
                if (view !== 'COMBAT' || !combatState?.isPlaying) { if (timerRef.current) clearInterval(timerRef.current); return; }
                timerRef.current = setInterval(() => {
                    const now = Date.now();
                    lastBeatTimeRef.current = now;
                    setBeat(prev => prev + 1);
                }, BEAT_MS);
                return () => clearInterval(timerRef.current);
            }, [view, combatState?.isPlaying]);

            useEffect(() => {
                if (beat === 0 || !combatState?.isPlaying) return;
                setCombatState(prev => {
                    if (!prev) return null;
                    const newPlayerTeam = [...prev.playerTeam];
                    const newEnemyTeam = [...prev.enemyTeam];
                    const logs = [...prev.logs];
                    const currentMeasure = Math.floor((beat - 1) / 4) + 1;

                    if ((beat - 1) % 4 === 0) newPlayerTeam.forEach(p => { if (p && p.skillCooldown > 0) p.skillCooldown--; });

                    const currentBonus = conductorBonus;
                    const playerActions = [];
                    const enemyActions = [];

                    newPlayerTeam.forEach((p, idx) => {
                        if (p && !p.isDead && beat % p.interval === 0) {
                            const targetIdx = findTargetIndex(idx, newEnemyTeam);
                            if (targetIdx !== null) playerActions.push({ sourceIdx: idx, targetIdx });
                        }
                    });
                    newEnemyTeam.forEach((e, idx) => {
                        if (e && !e.isDead && beat % e.interval === 0) {
                            const targetIdx = findTargetIndex(idx, newPlayerTeam);
                            if (targetIdx !== null) enemyActions.push({ sourceIdx: idx, targetIdx });
                        }
                    });

                    const handledPlayers = new Set();
                    const handledEnemies = new Set();

                    playerActions.forEach(pAct => {
                        const eAct = enemyActions.find(e => e.sourceIdx === pAct.targetIdx && e.targetIdx === pAct.sourceIdx);
                        if (eAct) {
                            const p = newPlayerTeam[pAct.sourceIdx];
                            const e = newEnemyTeam[eAct.sourceIdx];
                            const pAtkFinal = Math.floor(p.atk * currentBonus);
                            const pDmg = Math.floor(pAtkFinal * getElementEffectiveness(p.element, e.element));
                            const eDmg = Math.floor(e.atk * getElementEffectiveness(e.element, p.element));

                            if (pDmg >= eDmg) {
                                const diff = Math.max(1, pDmg - eDmg);
                                e.hp -= diff;
                                logs.unshift(`‚öîÔ∏è WIN! ${p.name} (-${diff})`);
                            } else {
                                const diff = Math.max(1, eDmg - pDmg);
                                p.hp -= diff;
                                logs.unshift(`üí• LOSE! ${p.name} (-${diff})`);
                            }
                            handledPlayers.add(pAct.sourceIdx);
                            handledEnemies.add(eAct.sourceIdx);
                        }
                    });

                    playerActions.forEach(pAct => {
                        if (handledPlayers.has(pAct.sourceIdx)) return;
                        const p = newPlayerTeam[pAct.sourceIdx];
                        const e = newEnemyTeam[pAct.targetIdx];
                        const pAtkFinal = Math.floor(p.atk * currentBonus);
                        const dmg = Math.floor(pAtkFinal * getElementEffectiveness(p.element, e.element));
                        e.hp -= dmg;
                    });

                    enemyActions.forEach(eAct => {
                        if (handledEnemies.has(eAct.sourceIdx)) return;
                        const e = newEnemyTeam[eAct.sourceIdx];
                        const p = newPlayerTeam[eAct.targetIdx];
                        const dmg = Math.floor(e.atk * getElementEffectiveness(e.element, p.element));
                        p.hp -= dmg;
                    });

                    newPlayerTeam.forEach(p => { if (p && p.hp <= 0) { p.hp = 0; p.isDead = true; } });
                    newEnemyTeam.forEach(e => { if (e && e.hp <= 0) { e.hp = 0; e.isDead = true; } });

                    const pAlive = newPlayerTeam.some(p => p && !p.isDead);
                    const eAlive = newEnemyTeam.some(e => e && !e.isDead);
                    let result = null;
                    let isPlaying = true;
                    if (!pAlive) { result = 'LOSE'; isPlaying = false; }
                    else if (!eAlive) { result = 'WIN'; isPlaying = false; }

                    return { ...prev, playerTeam: newPlayerTeam, enemyTeam: newEnemyTeam, logs: logs.slice(0, 3), measure: currentMeasure, result, isPlaying };
                });
            }, [beat]);

            const handleRhythmInput = useCallback(() => {
                if (!combatRef.current?.isPlaying) return;
                const now = Date.now();
                const timeSinceLast = now - lastBeatTimeRef.current;
                const timeToNext = BEAT_MS - timeSinceLast;
                const diff = Math.min(timeSinceLast, timeToNext);

                let grade = "MISS", multiplier = 0.5, color = "text-gray-500", scale = 0.8;
                if (diff < 100) { grade = "PERFECT"; multiplier = 1.5; color = "text-gold-400"; scale = 1.5; }
                else if (diff < 200) { grade = "GREAT"; multiplier = 1.2; color = "text-blue-400"; scale = 1.2; }
                else if (diff < 300) { grade = "GOOD"; multiplier = 1.0; color = "text-green-400"; scale = 1.0; }
                else { grade = "MISS"; multiplier = 0.7; color = "text-red-500"; scale = 0.9; }

                setConductorBonus(multiplier);
                setRhythmFeedback(prev => ({ text: grade, color: color, scale: scale, combo: grade === "MISS" ? 0 : prev.combo + 1 }));
                setTimeout(() => setRhythmFeedback(prev => ({ ...prev, scale: 1 })), 100);
            }, [BEAT_MS]);

            const handleSkillInput = useCallback((laneIdx) => {
                if (!combatRef.current?.isPlaying) return;
                setCombatState(prev => {
                    const pTeam = [...prev.playerTeam];
                    const eTeam = [...prev.enemyTeam];
                    const p = pTeam[laneIdx];
                    if (!p || p.isDead || p.skillCooldown > 0) return prev;

                    const bonus = conductorBonus;
                    p.skillCooldown = p.maxCooldown;

                    const logs = [...prev.logs];
                    logs.unshift(`‚ú® ${p.name} Solo! (x${bonus})`);

                    const targetIdx = findTargetIndex(laneIdx, eTeam);
                    if (targetIdx !== null) {
                        const e = eTeam[targetIdx];
                        const dmg = Math.floor(p.atk * 3.0 * bonus);
                        e.hp -= dmg;
                        if (e.hp <= 0) { e.hp = 0; e.isDead = true; }
                    }
                    p.hp = Math.min(p.maxHp, p.hp + Math.floor(p.maxHp * 0.3 * bonus));
                    return { ...prev, playerTeam: pTeam, enemyTeam: eTeam, logs };
                });
            }, [conductorBonus]);

            useEffect(() => {
                const handleKeyDown = (e) => {
                    if (!combatRef.current?.isPlaying) return;
                    if (e.code === 'Space' || e.code === 'Enter') { e.preventDefault(); handleRhythmInput(); }
                    if (['1', '2', '3', '4', '5'].includes(e.key)) { handleSkillInput(parseInt(e.key) - 1); }
                };
                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, [handleRhythmInput, handleSkillInput]);

            // --- UI Components ---
            const CharacterCard = ({ char, isSelected, showHp = false, idx }) => {
                if (!char) return <div className="w-full h-full border-2 border-dashed border-wood-600 rounded-lg flex items-center justify-center text-wood-600 bg-wood-800/50">Empty</div>;

                const getSafeWidth = () => {
                    if (!char || typeof char.hp !== 'number' || typeof char.maxHp !== 'number' || char.maxHp <= 0) return '0%';
                    const pct = (char.hp / char.maxHp) * 100;
                    return `${Math.max(0, Math.min(100, pct))}%`;
                };

                const isDead = showHp && char.hp <= 0;
                const hpPctNum = (char.hp / (char.maxHp || 1)) * 100;

                return (
                    <div className={`relative w-full h-full rounded-lg p-2 flex flex-col border-2 transition-all overflow-hidden ${RARITIES[char.rarity].bg} ${isSelected ? 'ring-4 ring-gold-500 z-10 shadow-[0_0_15px_#d4af37]' : RARITIES[char.rarity].border} ${isDead ? 'grayscale opacity-40' : ''}`}>
                        {showHp && (
                            <div className="w-full h-2 bg-wood-900 rounded-full mb-2 border border-wood-600">
                                <div className={`h-full rounded-full transition-all duration-300 ${hpPctNum < 30 ? 'bg-red-600' : 'bg-green-600'}`} style={{ width: getSafeWidth() }}></div>
                            </div>
                        )}
                        <div className="flex justify-between items-start mb-1">
                            <span className={`text-xl drop-shadow-md ${ELEMENTS[char.element].color}`}>{ELEMENTS[char.element].icon}</span>
                            <span className={`text-[9px] px-1.5 py-0.5 rounded bg-black/60 font-bold font-serif border border-white/10 ${RARITIES[char.rarity].color}`}>{RARITIES[char.rarity].name}</span>
                        </div>
                        <div className="flex-1 flex flex-col justify-center items-center text-center">
                            <div className="font-bold text-xs truncate w-full text-ivory leading-tight drop-shadow-sm font-serif">{char.name}</div>
                        </div>
                        <div className="text-[10px] flex justify-between text-gold-100 bg-black/40 rounded px-1 py-0.5 mt-auto border-t border-white/5">
                            <span>‚öîÔ∏è{char.atk}</span>
                            <span>‚è±Ô∏è{char.interval}</span>
                        </div>
                        {showHp && typeof idx === 'number' && (
                            <div className="absolute bottom-0 right-0 bg-wood-900 text-gold-400 text-[10px] px-1.5 py-0.5 rounded-tl border-l border-t border-gold-600 font-mono font-bold">{idx + 1}</div>
                        )}
                    </div>
                );
            };

            // --- Views ---
            const renderMenu = () => (
                <div className="min-h-screen flex flex-col items-center justify-center relative wood-texture bg-wood-900">
                    <div className="absolute inset-0 bg-gradient-to-b from-black/50 to-wood-900/90"></div>
                    <div className="z-10 text-center border-y-4 border-double border-gold-600 py-12 px-8 bg-black/30 backdrop-blur-sm w-full max-w-2xl">
                        <h1 className="text-6xl font-bold mb-2 text-transparent bg-clip-text bg-gradient-to-r from-gold-300 via-gold-500 to-gold-700 drop-shadow-lg font-serif">Symphony</h1>
                        <p className="text-gold-400 uppercase tracking-[0.5em] text-sm mb-8 font-serif border-b border-gold-600/30 pb-4 inline-block">Rhythm Edition</p>
                        <div className="flex flex-col gap-4 w-64 mx-auto">
                            <button onClick={() => setView('STAGE')} className="group py-3 bg-wood-800 border border-gold-600 hover:bg-wood-700 hover:border-gold-400 rounded text-ivory font-serif transition-all flex items-center justify-center gap-2 shadow-lg">
                                <Play size={16} color="#d4af37" /> Start Tour
                            </button>
                            <button onClick={() => setView('FORMATION')} className="group py-3 bg-wood-800 border border-gold-600 hover:bg-wood-700 hover:border-gold-400 rounded text-ivory font-serif transition-all flex items-center justify-center gap-2 shadow-lg">
                                <Users size={16} color="#d4af37" /> Formation
                            </button>
                            <button onClick={() => setView('GACHA')} className="group py-3 bg-wood-800 border border-gold-600 hover:bg-wood-700 hover:border-gold-400 rounded text-ivory font-serif transition-all flex items-center justify-center gap-2 shadow-lg">
                                <Gift size={16} color="#d4af37" /> Recruit
                            </button>
                        </div>
                    </div>
                    <div className="z-10 mt-8 text-gold-600 text-xs font-serif">Conduct the Battlefield with Rhythm</div>
                </div>
            );

            const renderGacha = () => {
                const doGacha = () => { if (currency >= 100) { setCurrency(c => c - 100); const char = generateCharacter(); setGachaResult(char); setInventory(p => [...p, char]); } };
                return (
                    <div className="min-h-screen bg-wood-900 wood-texture flex items-center justify-center p-4">
                        <div className="bg-wood-800 border-2 border-gold-600 p-8 rounded-lg max-w-md w-full text-center relative shadow-2xl">
                            <button onClick={() => setView('MENU')} className="absolute top-2 right-2 text-gold-500 hover:text-ivory font-bold">‚úï</button>
                            {!gachaResult ? (
                                <>
                                    <div className="text-5xl mb-4 mx-auto text-gold-500 animate-bounce"><Music size={48} /></div>
                                    <h2 className="text-3xl text-gold-400 mb-4 font-serif border-b border-wood-600 pb-2">Recruit Musician</h2>
                                    <div className="text-ivory mb-6 font-serif text-lg bg-black/30 py-2 rounded border border-wood-600">Funds: <span className="text-gold-400">{currency} G</span></div>
                                    <button onClick={doGacha} disabled={currency < 100} className="w-full py-3 bg-gradient-to-r from-gold-700 to-gold-600 hover:from-gold-600 hover:to-gold-500 text-wood-900 font-bold rounded shadow-lg border border-gold-400 disabled:opacity-50 disabled:cursor-not-allowed transition-all transform active:scale-95 font-serif">
                                        Summon (100G)
                                    </button>
                                </>
                            ) : (
                                <div className="animate-bounce">
                                    <h3 className="text-2xl text-gold-300 mb-4 font-serif">New Arrival!</h3>
                                    <div className="flex justify-center mb-6 transform scale-125 h-56 w-40 mx-auto shadow-2xl"><CharacterCard char={gachaResult} /></div>
                                    <button onClick={() => setGachaResult(null)} className="w-full py-2 border border-gold-600 text-gold-400 hover:bg-gold-600/20 rounded font-serif">Confirm</button>
                                </div>
                            )}
                        </div>
                    </div>
                );
            };

            const renderFormation = () => (
                <div className="min-h-screen bg-wood-900 wood-texture p-4 flex flex-col">
                    <div className="flex justify-between items-center mb-6 border-b border-gold-600 pb-4 bg-black/20 p-4 rounded-t-lg">
                        <h2 className="text-3xl text-gold-500 font-serif">Orchestra Formation</h2>
                        <button onClick={() => setView('MENU')} className="px-4 py-2 bg-wood-700 border border-gold-600 text-gold-100 rounded hover:bg-wood-600 font-serif">Back to Hall</button>
                    </div>
                    <div className="flex-1 flex flex-col md:flex-row gap-6">
                        <div className="flex-1 bg-wood-800 p-6 rounded-lg border border-wood-600 flex flex-col items-center justify-center shadow-inner relative">
                            <div className="absolute top-2 left-4 text-wood-600 font-serif text-sm tracking-widest">STAGE PREVIEW</div>
                            <div className="grid grid-cols-5 gap-3 w-full max-w-4xl">
                                {formation.map((charIdx, slotId) => (
                                    <div key={slotId} className="text-center group">
                                        <div className="text-xs text-gold-600 mb-1 font-serif tracking-wider group-hover:text-gold-400">LANE {slotId + 1}</div>
                                        <div onClick={() => { const newF = [...formation]; newF[slotId] = null; setFormation(newF); }} className="aspect-[3/4] cursor-pointer hover:scale-105 transition-transform shadow-lg">
                                            <CharacterCard char={charIdx !== null ? inventory[charIdx] : null} />
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                        <div className="h-64 md:h-auto md:w-1/3 bg-[#251e17] p-4 rounded-lg border border-wood-600 overflow-y-auto shadow-xl">
                            <h3 className="mb-4 text-gold-400 font-serif border-b border-wood-600 pb-2">Instrument Storage</h3>
                            <div className="grid grid-cols-3 gap-2">
                                {inventory.map((char, idx) => (
                                    <div key={char.id} className={`aspect-[3/4] cursor-pointer transition-all ${formation.includes(idx) ? 'opacity-40 grayscale' : 'hover:ring-2 ring-gold-500 hover:shadow-lg'}`}
                                        onClick={() => { if (!formation.includes(idx)) { const empty = formation.indexOf(null); const f = [...formation]; f[empty !== -1 ? empty : 0] = idx; setFormation(f); } }}>
                                        <CharacterCard char={char} />
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );

            const renderStage = () => (
                <div className="min-h-screen bg-wood-900 wood-texture p-8 overflow-y-auto">
                    <div className="flex justify-between items-center mb-8 border-b-2 border-gold-600 pb-4 bg-black/20 p-4 rounded-lg">
                        <h2 className="text-4xl font-serif text-gold-500 drop-shadow-sm">World Tour Schedule</h2>
                        <button onClick={() => setView('MENU')} className="px-6 py-2 bg-wood-700 border border-gold-600 text-gold-100 rounded hover:bg-wood-600 font-serif">Back</button>
                    </div>
                    <div className="grid grid-cols-5 md:grid-cols-8 lg:grid-cols-10 gap-3">
                        {Array.from({ length: 100 }, (_, i) => i + 1).map(num => (
                            <button key={num} disabled={num > currentStage} onClick={() => startCombat(num)}
                                className={`aspect-square border-2 flex flex-col items-center justify-center rounded-lg text-lg font-serif transition-all shadow-md
                                    ${num > currentStage ? 'bg-wood-800 text-wood-600 border-wood-700 cursor-not-allowed' : 'bg-[#3e2b1e] text-gold-200 border-gold-700 hover:bg-[#5c402b] hover:border-gold-400 hover:text-white hover:scale-105 hover:shadow-gold-900/50'} 
                                    ${num % 10 === 0 ? 'border-red-900 bg-red-950/30 text-red-400' : ''}`}>
                                <span className="font-bold">{num}</span>
                                {num % 10 === 0 && <span className="text-xs mt-1 text-red-500"><Skull size={14} /></span>}
                            </button>
                        ))}
                    </div>
                </div>
            );

            const renderCombatView = () => {
                if (!combatState) return null;
                const { playerTeam, enemyTeam, measure, logs, result } = combatState;
                return (
                    <div className="min-h-screen bg-wood-900 flex flex-col relative overflow-hidden select-none">
                        <div className="absolute inset-0 bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-wood-800 via-wood-900 to-black pointer-events-none"></div>
                        <div className="absolute inset-0 opacity-10 bg-[url('https://www.transparenttextures.com/patterns/dark-wood.png')]"></div>

                        {/* Rhythm Feedback */}
                        <div className="absolute top-1/3 left-1/2 -translate-x-1/2 z-50 text-center pointer-events-none transform -translate-y-1/2">
                            <div className={`text-8xl font-black italic transition-all duration-75 drop-shadow-[0_5px_5px_rgba(0,0,0,0.8)] font-serif ${rhythmFeedback.color}`} style={{ transform: `scale(${rhythmFeedback.scale})` }}>{rhythmFeedback.text}</div>
                            {rhythmFeedback.combo > 1 && <div className="text-3xl text-gold-400 font-bold mt-4 font-serif animate-bounce drop-shadow-md">{rhythmFeedback.combo} COMBO!</div>}
                        </div>

                        {/* Header */}
                        <div className="p-3 bg-gradient-to-b from-black/80 to-transparent flex justify-between items-center z-10 border-b border-gold-600/30">
                            <div>
                                <span className="text-gold-500 font-bold font-serif text-xl mr-4">Stage {combatState.stage}</span>
                                <span className="text-sm text-wood-500 font-mono bg-black/40 px-2 py-1 rounded border border-wood-700">Measure: {measure}</span>
                            </div>
                            <div className="flex gap-2 bg-black/40 px-3 py-1 rounded-full border border-wood-700">
                                {[0, 1, 2, 3].map(i => <div key={i} className={`w-3 h-3 rounded-full transition-all duration-75 ${beat % 4 === i ? 'bg-gold-400 shadow-[0_0_10px_#ffd700] scale-125' : 'bg-wood-700'}`}></div>)}
                            </div>
                            <button onClick={() => setView('MENU')} className="text-xs text-wood-400 px-3 py-1 border border-wood-600 hover:text-ivory hover:border-gold-500 rounded font-serif">Surrender</button>
                        </div>

                        {/* Battlefield */}
                        <div className="flex-1 flex flex-col justify-center p-4 max-w-5xl mx-auto w-full z-10 gap-4">
                            {/* Enemy */}
                            <div className="flex-1 flex items-end pb-2 border-b border-gold-900/30">
                                <div className="grid grid-cols-5 gap-3 w-full">
                                    {enemyTeam.map((char, i) => (
                                        <div key={i} className={`relative transition-all duration-150 h-28 md:h-36 ${char && beat % char.interval === 0 && !char.isDead ? 'translate-y-4 z-20' : ''}`}>
                                            {char && <CharacterCard char={char} showHp={true} />}
                                            {char && beat % char.interval === 0 && !char.isDead && <div className="absolute inset-0 bg-red-500/20 animate-pulse rounded-lg shadow-[0_0_20px_#800000]"></div>}
                                        </div>
                                    ))}
                                </div>
                            </div>

                            {/* Logs */}
                            <div className="h-10 flex items-center justify-center text-sm md:text-base text-gold-200 bg-black/60 rounded-full border-y border-gold-900/50 backdrop-blur-sm my-2 font-serif px-8 shadow-lg">
                                {logs[0]}
                            </div>

                            {/* Player */}
                            <div className="flex-1 flex items-start pt-2">
                                <div className="grid grid-cols-5 gap-3 w-full">
                                    {playerTeam.map((char, i) => (
                                        <div key={i} className="flex flex-col gap-2 h-full group">
                                            <div className={`relative transition-all duration-150 h-28 md:h-36 ${char && beat % char.interval === 0 && !char.isDead ? '-translate-y-4 z-20 scale-105' : ''}`}>
                                                {char && <CharacterCard char={char} showHp={true} idx={i} />}
                                                {char && beat % char.interval === 0 && !char.isDead && <div className="absolute inset-0 bg-gold-500/20 animate-pulse rounded-lg shadow-[0_0_20px_#b8860b]"></div>}
                                            </div>
                                            {char && !char.isDead && (
                                                <div className={`text-[10px] font-bold text-center py-1.5 rounded border transition-all font-serif tracking-widest shadow-md
                                                    ${char.skillCooldown === 0 ? 'bg-gold-600 border-gold-400 text-wood-900 animate-pulse cursor-pointer' : 'bg-wood-800 border-wood-600 text-wood-500'}`}>
                                                    {char.skillCooldown === 0 ? "SOLO!" : `${char.skillCooldown} M`}
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>

                        {/* Result Modal */}
                        {result && (
                            <div className="absolute inset-0 z-50 bg-black/90 flex flex-col items-center justify-center animate-in fade-in duration-700">
                                <div className="text-6xl mb-4">{result === 'WIN' ? 'üèÜ' : 'ü•Ä'}</div>
                                <h1 className={`text-6xl font-serif mb-4 drop-shadow-lg ${result === 'WIN' ? 'text-gold-400' : 'text-gray-500'}`}>{result === 'WIN' ? 'Curtain Call' : 'Silence'}</h1>
                                <div className="text-2xl mb-8 text-ivory font-serif">Max Combo: <span className="text-gold-500 font-bold">{rhythmFeedback.combo}</span></div>
                                <button onClick={() => {
                                    if (result === 'WIN') {
                                        setCurrency(c => c + 300);
                                        if (combatState.stage === currentStage) setCurrentStage(s => s + 1);
                                    }
                                    setView('STAGE');
                                    setCombatState(null);
                                }} className="px-10 py-4 bg-gold-600 hover:bg-gold-500 text-wood-900 font-bold rounded-lg shadow-[0_0_20px_#aa7e08] hover:scale-105 transition-transform font-serif text-lg border border-gold-400">
                                    {result === 'WIN' ? 'Backstage' : 'Return'}
                                </button>
                            </div>
                        )}

                        <div className="absolute bottom-2 right-2 text-[10px] text-wood-600 font-mono">Controls: SPACE (Rhythm), 1-5 (Skill)</div>
                    </div>
                );
            };

            // Router Logic
            switch (view) {
                case 'MENU': return renderMenu();
                case 'GACHA': return renderGacha();
                case 'FORMATION': return renderFormation();
                case 'STAGE': return renderStage();
                case 'COMBAT': return renderCombatView();
                default: return renderMenu();
            }
        }

        // Render
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>

</html>